%global pypi_name rlc.cloud-repos
%global pkg_name rlc.cloud_repos
%global rpm_name rlc-cloud-repos

%global python_wheelname %{pkg_name}-%{version}-py3-none-any.whl
%global build_wheel 1

Name:           python%{python3_pkgversion}-%{rpm_name}
Version:        VERSION
Release:        1%{?dist}
Summary:        A cloud-init querying and repository configuration tool for Rocky Linux from CIQ Products (RLC)

License:        MIT
URL:            https://ciq.com/
Source0:        %{pypi_name}-%{version}.tar.gz

BuildArch:      noarch
BuildRequires:  python%{python3_pkgversion}-devel
BuildRequires:  pyproject-rpm-macros

Requires:       python%{python3_pkgversion}-PyYAML
Requires:       cloud-init

%description
Installs a utility plus cloud-init configuration to run the utility on first and every boot to check the instance metadata and update the RLC RPM repositories to point to the appropriate source.

%prep
%setup -q -n %{pypi_name}-%{version}

%generate_buildrequires
%pyproject_buildrequires

%build
%pyproject_wheel

%install
%pyproject_install
%pyproject_save_files rlc

# Move files from Python data dirs to proper system locations
mkdir -p %{buildroot}%{_sysconfdir}/rlc-cloud-repos/plugins.d
install -Dm0644 %{buildroot}%{_prefix}/config/20_rlc-cloud-repos.cfg %{buildroot}/etc/cloud/cloud.cfg.d/20_rlc-cloud-repos.cfg
install -Dm0644 %{buildroot}%{_prefix}/data/ciq-mirrors.yaml %{buildroot}/usr/share/rlc-cloud-repos/ciq-mirrors.yaml
mkdir -p %{buildroot}%{_docdir}/%{name}
cp %{buildroot}%{_prefix}/docs/*.template %{buildroot}%{_docdir}/%{name}/

# Clean up Python-installed data files since we moved them to system locations
rm -rf %{buildroot}%{_prefix}/config %{buildroot}%{_prefix}/data %{buildroot}%{_prefix}/docs

%files -f %{pyproject_files}
%license LICENSE
%doc README.md CONTRIBUTING.md COMMUNITY.md SECURITY.md

# CLI entrypoint (console script)
%{_bindir}/rlc-cloud-repos

# Namespace package file
%{python3_sitelib}/rlc.cloud_repos-*.pth

# Config and static data
%dir %{_sysconfdir}/rlc-cloud-repos
%dir %{_sysconfdir}/rlc-cloud-repos/plugins.d
%config(noreplace) %{_sysconfdir}/cloud/cloud.cfg.d/20_rlc-cloud-repos.cfg
/usr/share/rlc-cloud-repos/ciq-mirrors.yaml
%{_docdir}/%{name}/*.template

%postun
rm -f /etc/rlc-cloud-repos/.configured

%changelog
* Thu Jun 19 2025 Joseph Tate <jtate@ciq.com> - 0.2.1-1
- Re-release to write the cloudcontentdir var instead of contentdir

* Wed Jun 11 2025 Joseph Tate <jtate@ciq.com> - 0.2.0-1
- Switch AWS repositories for bucket mirrors
- Support AWS bucket mirrors

* Mon Mar 31 2025 Joel Hanger <jhanger@ciq.com> - 0.1.0-1
- Initial version
